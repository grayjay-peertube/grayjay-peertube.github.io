<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeerTube Instances</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Home</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
    </nav>

    <div class="container mt-5">
        <table id="instancesTable" class="table table-striped table-bordered" style="width:100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Host</th>
                    <th>Name</th>
                    <th>Total Users</th>
                    <th>Total Videos</th>
                    <th>Version</th>
                    <th>Signup Allowed</th>
                    <th>Languages</th>
                    <th>Health</th>
                    <th>Created At</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Popper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- QR Code Generator JS -->
    <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>

    <script src="./js/config.js"></script>

    <script>
        $(document).ready(function () {
            // Initialize DataTable
            $('#instancesTable').DataTable({
                ajax: {
                    url: peerTubeInstancesBaseUrl,
                    dataSrc: 'data'
                },
                columns: [
                    { data: 'id' },
                    {
                        data: 'host',
                        render: function (data) {
                            // Render the host as a hyperlink using string interpolation
                            return `<a href="https://${data}" target="_blank" rel=noopener>${data}</a>`;
                        }
                    },
                    {
                        data: 'name',
                        render: function (data, type, row) {
                            // Use the name as the text and short description as the tooltip
                            return `<span data-toggle="tooltip" title="${row.shortDescription}">${data}</span>`;
                        }
                    },
                    { data: 'totalUsers' },
                    { data: 'totalVideos' },
                    { data: 'version' },
                    { data: 'signupAllowed' },
                    { data: 'languages' },
                    { data: 'health' },
                    {
                        data: 'createdAt',
                        render: function (data) {
                            // Format createdAt to display only the date
                            if (data)
                                return new Date(data).toLocaleDateString();
                        }
                    }
                ],
                columnDefs: [
                    // Handle columns not found
                    { targets: '_all', defaultContent: '' }
                ],
                paging: true, // Enable paging
                pageLength: 10, // Number of rows per page
                lengthMenu: [10, 25, 50, 100], // Options for number of rows per page
                scrollY: false, // Disable vertical scrolling
                initComplete: function () {
                    // Initialize tooltips after DataTables is fully initialized
                    $('[data-toggle="tooltip"]').tooltip();

                    // Add click event to show SweetAlert2 alert
                    $('#instancesTable tbody').on('dblclick ', 'tr', function () {
                        var data = $('#instancesTable').DataTable().row(this).data();

                        if (data.host) {

                            // Get the text of the host:
                            const qrText = `${apibaseUrl}${data.host}`;
                            
                            // Make the QR code:
                            let qr = qrcode(0, 'L');
                            qr.addData(qrText);
                            qr.make();
                            // Create an image from it:


                            let qrImg = qr.createImgTag(10, 8, "qr code of " + qrText);

                            Swal.fire({
                                title: `Add ${data.host}`,
                                html: `<div id="qrCode">${qrImg}</div>`,
                                // icon: 'info',
                                confirmButtonText: 'OK'
                            });
                        }
                    });
                }
            });
        });
    </script>